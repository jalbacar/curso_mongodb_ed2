services:
  mongo1:
    container_name: mongo1
    image: mongo:7
    command: ["mongod","--replSet","${MONGO_REPLSET}","--bind_ip_all","--port","27017"]
    ports:
      - "${MONGO1_PORT}:27017"
    volumes:
      - mongo1_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --host localhost --port 27017 --eval \"db.adminCommand({ ping: 1 }).ok\" | grep 1 >/dev/null"]
      interval: 2s
      timeout: 5s
      retries: 60
      start_period: 10s

  mongo2:
    container_name: mongo2
    image: mongo:7
    command: ["mongod","--replSet","${MONGO_REPLSET}","--bind_ip_all","--port","27018"]
    ports:
      - "${MONGO2_PORT}:27018"
    volumes:
      - mongo2_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --host localhost --port 27018 --eval \"db.adminCommand({ ping: 1 }).ok\" | grep 1 >/dev/null"]
      interval: 2s
      timeout: 5s
      retries: 60
      start_period: 10s

  mongo3:
    container_name: mongo3
    image: mongo:7
    command: ["mongod","--replSet","${MONGO_REPLSET}","--bind_ip_all","--port","27019"]
    ports:
      - "${MONGO3_PORT}:27019"
    volumes:
      - mongo3_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --host localhost --port 27019 --eval \"db.adminCommand({ ping: 1 }).ok\" | grep 1 >/dev/null"]
      interval: 2s
      timeout: 5s
      retries: 60
      start_period: 10s

  init-rs:
    image: mongo:7
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
    restart: "no"
    command: >
      mongosh --host mongo1:27017 --eval
      'rs.initiate({_id:"rs0",members:[
        {_id:0,host:"mongo1:27017",priority:2},
        {_id:1,host:"mongo2:27018",priority:1},
        {_id:2,host:"mongo3:27019",priority:1}
      ]})'

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
